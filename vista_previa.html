<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - TDR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .no-print {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-volver {
            background-color: #6c757d;
            color: white;
        }

        .btn-imprimir {
            background-color: #007bff;
            color: white;
        }

        .btn-descargar {
            background-color: #28a745;
            color: white;
        }

        .documento {
            background: white;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 297mm;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0056b3;
        }

        .header h1 {
            color: #0056b3;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .header .codigo {
            font-size: 14px;
            color: #666;
        }

        .datos-generales {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .datos-generales table {
            width: 100%;
            border-collapse: collapse;
        }

        .datos-generales td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .datos-generales td:first-child {
            font-weight: bold;
            width: 40%;
            color: #495057;
        }

        .seccion {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .seccion-titulo {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .seccion-contenido {
            padding: 15px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
            text-align: justify;
        }

        .subseccion {
            margin-top: 15px;
            padding-left: 20px;
        }

        .subseccion-titulo {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .instructivo {
            font-style: italic;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 10px;
            padding: 8px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .documento {
                box-shadow: none;
                margin: 0;
                padding: 15mm;
            }

            .seccion {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <button class="btn btn-volver" onclick="volverFormulario()">Volver al Formulario</button>
        <button class="btn btn-imprimir" onclick="window.print()">Imprimir / Guardar PDF</button>
        <button class="btn btn-descargar" onclick="descargarJSON()">Descargar JSON</button>
    </div>

    <div class="documento" id="documento">
        <div class="header">
            <h1>TERMINOS DE REFERENCIA PARA LA CONTRATACION DE SERVICIOS EN GENERAL</h1>
            <div class="codigo">Codigo: PS 04 01 01 - FORM 01</div>
        </div>

        <div id="contenido-documento">
            <!-- El contenido se generara dinamicamente con JavaScript -->
        </div>

        <div class="footer">
            <p>Junta Nacional de Justicia</p>
            <p id="fecha-generacion"></p>
        </div>
    </div>

    <script>
        // Cargar datos del sessionStorage
        const datosJSON = sessionStorage.getItem('tdr_datos_temporales');

        if (!datosJSON) {
            alert('No hay datos para mostrar. Sera redirigido al formulario.');
            window.location.href = 'index.html';
        }

        const datos = JSON.parse(datosJSON);
        console.log('Datos cargados para vista previa:', datos);

        // Generar contenido del documento
        function generarDocumento() {
            const contenedor = document.getElementById('contenido-documento');
            let html = '';

            // Datos Generales
            html += `
                <div class="datos-generales">
                    <table>
                        <tr>
                            <td>Meta Presupuestaria:</td>
                            <td>${obtenerNombreMeta(datos.metaPresupuestaria) || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Unidad de Organizacion:</td>
                            <td>${datos.unidadOrganizacion || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Actividad del POI:</td>
                            <td>${obtenerNombresActividades(datos.actividadPOI) || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Denominacion de la Contratacion:</td>
                            <td>${datos.denominacionContratacion || 'No especificado'}</td>
                        </tr>
                    </table>
                </div>
            `;

            // Secciones numeradas
            const secciones = [
                { num: '1', titulo: 'Finalidad Publica', campo: 'finalidadPublica_1__finalidad_publica' },
                { num: '2', titulo: 'Antecedentes', campo: 'antecedentes_2__antecedentes' },
                { num: '3', titulo: 'Objetivo de la Contratacion', subsecciones: [
                    { titulo: '3.1 Objetivo General', campo: 'objetivoGeneral_3__objetivo_de_la_contratacion' },
                    { titulo: '3.2 Objetivo Especifico', campo: 'objetivoEspecifico_3__objetivo_de_la_contratacion' }
                ]},
                { num: '4', titulo: 'Alcance y Descripcion del Servicio', campo: 'alcanceDescripcion_4__alcance_y_descripcion_del_servicio' },
                { num: '5', titulo: 'Requisitos del Proveedor y/o Personal', campo: 'requisitosProveedor_5__requisitos_del_proveedor_y_o_personal' },
                { num: '6', titulo: 'Perfeccionamiento', campo: 'perfeccionamiento_6__perfeccionamiento' },
                { num: '7', titulo: 'Lugar y Plazo de Ejecucion', subsecciones: [
                    { titulo: 'Lugar', campo: 'lugarEjecucion_7__lugar_y_plazo_de_ejecucion' },
                    { titulo: 'Plazo', campo: 'plazoEjecucion_7__lugar_y_plazo_de_ejecucion' }
                ]},
                { num: '8', titulo: 'Resultados Esperados-Entregables', campo: 'entregablesDescripcion_8__resultados_esperados_entregables' },
                { num: '9', titulo: 'Conformidad', campo: 'conformidadArea_9__conformidad' },
                { num: '10', titulo: 'Forma y Condiciones de Pago', campo: 'monedaPago_10__forma_y_condiciones_de_pago' },
                { num: '11', titulo: 'Confidencialidad', campo: 'textoConfidencialidad_11__confidencialidad' },
                { num: '12', titulo: 'Penalidades', campo: 'incluirPenalidadMora_12__penalidades' },
                { num: '13', titulo: 'Otras Penalidades', campo: 'otrasPenalidadesDescripcion_13__otras_penalidades' },
                { num: '14', titulo: 'Resolucion del Contrato', campo: 'incluirResolucionContrato_14__resolucion_del_contrato' },
                { num: '15', titulo: 'Clausula Garantias', campo: 'textoGarantias_15__clausula_garantias' },
                { num: '16', titulo: 'Clausula Gestion de Riesgos', campo: 'incluirGestionRiesgos_16__clausula_gestion_de_riesgos' },
                { num: '17', titulo: 'Clausula Anticorrupcion y Antisoborno', campo: 'incluirAnticorrupcion_17__clausula_anticorrupcion_y_antisoborno' },
                { num: '18', titulo: 'Clausula Solucion de Controversias', campo: 'incluirSolucionControversias_18__clausula_solucion_de_controversias' }
            ];

            secciones.forEach(seccion => {
                html += `<div class="seccion">`;
                html += `<div class="seccion-titulo">${seccion.num}. ${seccion.titulo}</div>`;
                html += `<div class="seccion-contenido">`;

                if (seccion.subsecciones) {
                    seccion.subsecciones.forEach(sub => {
                        html += `<div class="subseccion">`;
                        html += `<div class="subseccion-titulo">${sub.titulo}</div>`;
                        html += `<p>${datos[sub.campo] || 'No especificado'}</p>`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p>${datos[seccion.campo] || 'No especificado'}</p>`;
                }

                html += `</div></div>`;
            });

            contenedor.innerHTML = html;

            // Fecha de generacion
            document.getElementById('fecha-generacion').textContent =
                `Documento generado el: ${new Date().toLocaleDateString('es-PE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`;
        }

        function obtenerNombreMeta(metaId) {
            const metas = {
                '0012': '0012 - Gestion de Abastecimiento y Servicios Generales',
                '0025': '0025 - Gestion de Recursos Humanos',
                '0038': '0038 - Tecnologias de la Informacion',
                '0041': '0041 - Gestion Documentaria y Archivo'
            };
            return metas[metaId] || metaId;
        }

        function obtenerNombresActividades(actividadesArray) {
            if (!actividadesArray || actividadesArray.length === 0) return 'No especificado';
            return actividadesArray.join(', ');
        }

        function volverFormulario() {
            // Los datos ya estan en sessionStorage, solo navegamos de vuelta
            window.location.href = 'index.html';
        }

        function descargarJSON() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const tdrId = `TDR_${timestamp}`;

            const tdrCompleto = {
                id: tdrId,
                fecha_creacion: new Date().toISOString(),
                tipo: 'Servicio',
                meta: datos.metaPresupuestaria || '',
                unidad: datos.unidadOrganizacion || '',
                actividades: datos.actividadPOI || [],
                denominacion: datos.denominacionContratacion || '',
                secciones: datos,
                estado: 'borrador',
                ultima_modificacion: new Date().toISOString()
            };

            const dataStr = JSON.stringify(tdrCompleto, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${tdrId}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`TDR guardado como ${tdrId}.json`);
        }

        // Generar el documento al cargar
        generarDocumento();
    </script>
</body>
</html>
