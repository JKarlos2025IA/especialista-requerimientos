<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - TDR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            /* Fondo oscuro para pantalla */
            color: #e0e0e0;
            padding: 20px;
        }

        .no-print {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-volver {
            background-color: #6c757d;
            color: white;
        }

        .btn-imprimir {
            background-color: #007bff;
            color: white;
        }

        .btn-descargar {
            background-color: #28a745;
            color: white;
        }

        .documento {
            background: #1e1e1e;
            /* Papel oscuro */
            color: #e0e0e0;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            min-height: 297mm;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0056b3;
        }

        .header h1 {
            color: #0056b3;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .header .codigo {
            font-size: 14px;
            color: #666;
        }

        .datos-generales {
            background: #2d2d2d;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4dabf7;
        }

        .datos-generales td:first-child {
            font-weight: bold;
            width: 40%;
            color: #4dabf7;
        }

        .seccion-titulo {
            background: #2d2d2d;
            color: #4dabf7;
            padding: 10px 0;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .seccion-contenido {
            padding: 10px 0;
            background: transparent;
            border: none;
            line-height: 1.6;
            text-align: justify;
            color: #ccc;
        }

        .subseccion {
            margin-top: 15px;
            padding-left: 20px;
        }

        .subseccion-titulo {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .instructivo {
            font-style: italic;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 10px;
            padding: 8px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
        }

        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
            }

            .documento {
                background: white;
                color: black;
                box-shadow: none;
                margin: 0;
                padding: 15mm;
            }

            .seccion {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <div class="no-print">
        <button class="btn btn-volver" onclick="volverFormulario()">Volver al Formulario</button>
        <button class="btn btn-imprimir" onclick="window.print()">Imprimir / Guardar PDF</button>
        <button class="btn btn-descargar" onclick="descargarJSON()">Descargar JSON</button>
    </div>

    <div class="documento" id="documento">
        <div class="header">
            <h1>TERMINOS DE REFERENCIA PARA LA CONTRATACION DE SERVICIOS EN GENERAL</h1>
            <div class="codigo">Codigo: PS 04 01 01 - FORM 01</div>
        </div>

        <div id="contenido-documento">
            <!-- El contenido se generara dinamicamente con JavaScript -->
        </div>

        <div class="footer">
            <p>Junta Nacional de Justicia</p>
            <p id="fecha-generacion"></p>
        </div>
    </div>

    <script>
        // Cargar datos del sessionStorage
        const datosJSON = sessionStorage.getItem('tdr_datos_temporales');

        if (!datosJSON) {
            alert('No hay datos para mostrar. Sera redirigido al formulario.');
            window.location.href = 'index.html';
        }

        const datos = JSON.parse(datosJSON);
        console.log('Datos cargados para vista previa:', datos);

        // Generar contenido del documento
        function generarDocumento() {
            const contenedor = document.getElementById('contenido-documento');
            let html = '';

            // 1. Datos Generales
            if (datos.meta) {
                html += `
                    <div class="datos-generales">
                        <table>
                            <tr>
                                <td>Item:</td>
                                <td>${datos.meta.item || 'No especificado'}</td>
                            </tr>
                            <tr>
                                <td>Meta Presupuestaria:</td>
                                <td>${datos.meta.metaPresupuestariaTexto || datos.meta.metaPresupuestaria || 'No especificado'}</td>
                            </tr>
                            <tr>
                                <td>Unidad de Organizacion:</td>
                                <td>${datos.meta.unidadOrganizacion || 'No especificado'}</td>
                            </tr>
                            <tr>
                                <td>Actividad del POI:</td>
                                <td>${Array.isArray(datos.meta.actividadPOI) ? datos.meta.actividadPOI.join(', ') : (datos.meta.actividadPOI || 'No especificado')}</td>
                            </tr>
                            <tr>
                                <td>Denominacion de la Contratacion:</td>
                                <td>${datos.meta.denominacionContratacion || 'No especificado'}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // 2. Secciones Dinámicas
            if (datos.secciones && Array.isArray(datos.secciones)) {
                let contadorSeccion = 1;

                datos.secciones.forEach(seccion => {
                    if (!seccion.isApplicable) return; // Saltar secciones "No Aplica"

                    html += `<div class="seccion">`;

                    // Título con numeración dinámica (1., 2., 3...)
                    html += `<div class="seccion-titulo">${contadorSeccion}. ${seccion.title}</div>`;

                    html += `<div class="seccion-contenido">`;

                    // Contenido principal
                    if (seccion.content) {
                        // Convertir saltos de línea en párrafos
                        const parrafos = seccion.content.split('\n\n');
                        parrafos.forEach(p => {
                            if (p.trim()) html += `<p>${p.trim()}</p>`;
                        });
                    }

                    // Subsecciones
                    if (seccion.subsecciones && seccion.subsecciones.length > 0) {
                        let contadorSub = 1;
                        seccion.subsecciones.forEach(sub => {
                            html += `<div class="subseccion">`;
                            html += `<div class="subseccion-titulo">${contadorSeccion}.${contadorSub} ${sub.title}</div>`;
                            html += `<p>${sub.content || ''}</p>`;
                            html += `</div>`;
                            contadorSub++;
                        });
                    }

                    // Condiciones Adicionales (sin numeración de subtítulo, solo texto agregado)
                    if (seccion.additionalConditions && seccion.additionalConditions.length > 0) {
                        seccion.additionalConditions.forEach(cond => {
                            html += `<p style="margin-top: 10px;">${cond}</p>`;
                        });
                    }

                    html += `</div></div>`;
                    contadorSeccion++;
                });
            } else {
                html += '<p>No se encontraron secciones para generar.</p>';
            }

            contenedor.innerHTML = html;

            // Fecha de generacion
            document.getElementById('fecha-generacion').textContent =
                `Documento generado el: ${new Date().toLocaleDateString('es-PE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`;
        }

        function obtenerNombreMeta(metaId) {
            const metas = {
                '0012': '0012 - Gestion de Abastecimiento y Servicios Generales',
                '0025': '0025 - Gestion de Recursos Humanos',
                '0038': '0038 - Tecnologias de la Informacion',
                '0041': '0041 - Gestion Documentaria y Archivo'
            };
            return metas[metaId] || metaId;
        }

        function obtenerNombresActividades(actividadesArray) {
            if (!actividadesArray || actividadesArray.length === 0) return 'No especificado';
            return actividadesArray.join(', ');
        }

        function volverFormulario() {
            // Los datos ya estan en sessionStorage, solo navegamos de vuelta
            window.location.href = 'index.html';
        }

        function descargarJSON() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const tdrId = `TDR_${timestamp}`;

            const tdrCompleto = {
                id: tdrId,
                fecha_creacion: new Date().toISOString(),
                tipo: 'Servicio',
                meta: datos.metaPresupuestaria || '',
                unidad: datos.unidadOrganizacion || '',
                actividades: datos.actividadPOI || [],
                denominacion: datos.denominacionContratacion || '',
                secciones: datos,
                estado: 'borrador',
                ultima_modificacion: new Date().toISOString()
            };

            const dataStr = JSON.stringify(tdrCompleto, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${tdrId}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`TDR guardado como ${tdrId}.json`);
        }

        // Generar el documento al cargar
        generarDocumento();
    </script>
</body>

</html>