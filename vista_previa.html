<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - TDR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .no-print {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-volver {
            background-color: #6c757d;
            color: white;
        }

        .btn-imprimir {
            background-color: #007bff;
            color: white;
        }

        .btn-descargar {
            background-color: #28a745;
            color: white;
        }

        .documento {
            background: white;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 297mm;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0056b3;
        }

        .header h1 {
            color: #0056b3;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .header .codigo {
            font-size: 14px;
            color: #666;
        }

        .datos-generales {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .datos-generales table {
            width: 100%;
            border-collapse: collapse;
        }

        .datos-generales td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .datos-generales td:first-child {
            font-weight: bold;
            width: 40%;
            color: #495057;
        }

        .seccion {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .seccion-titulo {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .seccion-contenido {
            padding: 15px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
            text-align: justify;
        }

        .subseccion {
            margin-top: 15px;
            padding-left: 20px;
        }

        .subseccion-titulo {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .instructivo {
            font-style: italic;
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 10px;
            padding: 8px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 12px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .documento {
                box-shadow: none;
                margin: 0;
                padding: 15mm;
            }

            .seccion {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <button class="btn btn-volver" onclick="volverFormulario()">Volver al Formulario</button>
        <button class="btn btn-imprimir" onclick="window.print()">Imprimir / Guardar PDF</button>
        <button class="btn btn-descargar" onclick="descargarJSON()">Descargar JSON</button>
    </div>

    <div class="documento" id="documento">
        <div class="header">
            <h1>TERMINOS DE REFERENCIA PARA LA CONTRATACION DE SERVICIOS EN GENERAL</h1>
            <div class="codigo">Codigo: PS 04 01 01 - FORM 01</div>
        </div>

        <div id="contenido-documento">
            <!-- El contenido se generara dinamicamente con JavaScript -->
        </div>

        <div class="footer">
            <p>Junta Nacional de Justicia</p>
            <p id="fecha-generacion"></p>
        </div>
    </div>

    <script>
        // Cargar datos del sessionStorage
        const datosJSON = sessionStorage.getItem('tdr_datos_temporales');

        if (!datosJSON) {
            alert('No hay datos para mostrar. Sera redirigido al formulario.');
            window.location.href = 'index.html';
        }

        const datos = JSON.parse(datosJSON);
        console.log('Datos cargados para vista previa:', datos);

        // Generar contenido del documento
        function generarDocumento() {
            const contenedor = document.getElementById('contenido-documento');
            let html = '';

            // Datos Generales
            html += `
                <div class="datos-generales">
                    <table>
                        <tr>
                            <td>Item:</td>
                            <td>${datos.item || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Meta Presupuestaria:</td>
                            <td>${datos.metaPresupuestaria || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Unidad de Organizacion:</td>
                            <td>${datos.unidadOrganizacion || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <td>Actividad del POI:</td>
                            <td>${Array.isArray(datos.actividadPOI) ? datos.actividadPOI.join(', ') : (datos.actividadPOI || 'No especificado')}</td>
                        </tr>
                        <tr>
                            <td>Denominacion de la Contratacion:</td>
                            <td>${datos.denominacionContratacion || 'No especificado'}</td>
                        </tr>
                    </table>
                </div>
            `;

            // Mapeo de campos dinámicos a títulos legibles
            const camposMap = {
                // Sección 1
                'content_1__finalidad_publica': { num: '1', titulo: 'Finalidad Publica' },
                // Sección 2
                'content_2__antecedentes': { num: '2', titulo: 'Antecedentes' },
                // Sección 3
                'objetivoGeneral_3__objetivo_de_la_contratacion': { num: '3.1', titulo: 'Objetivo General' },
                'objetivoEspecifico_3__objetivo_de_la_contratacion': { num: '3.2', titulo: 'Objetivo Especifico' },
                // Sección 4
                'content_4__alcance_y_descripcion_del_servicio': { num: '4', titulo: 'Alcance y Descripcion del Servicio' },
                // Sección 5
                'content_5__requisitos_del_proveedor_y_o_personal': { num: '5', titulo: 'Requisitos del Proveedor y/o Personal' },
                // Sección 6
                'content_6__perfeccionamiento': { num: '6', titulo: 'Perfeccionamiento' },
                // Sección 7
                'lugarEjecucion_7__lugar_y_plazo_de_ejecucion': { num: '7.1', titulo: 'Lugar de Ejecución' },
                'plazoEjecucion_7__lugar_y_plazo_de_ejecucion': { num: '7.2', titulo: 'Plazo de Ejecución' },
                'plazoPersonalizado_7__lugar_y_plazo_de_ejecucion': { num: '7.3', titulo: 'Plazo Personalizado' },
                // Sección 8
                'tipoEntregables_8__resultados_esperados_entregables': { num: '8.1', titulo: 'Tipo de Entregables' },
                'entregablesDescripcion_8__resultados_esperados_entregables': { num: '8.2', titulo: 'Descripción Detallada de Entregables' },
                // Sección 9
                'conformidad_9__conformidad': { num: '9', titulo: 'Conformidad' },
                // Sección 10
                'monedaPago_10__forma_y_condiciones_de_pago': { num: '10.1', titulo: 'Moneda de Pago' },
                'detallePago_10__forma_y_condiciones_de_pago': { num: '10.2', titulo: 'Detalle del Pago' },
                'documentacionPago_10__forma_y_condiciones_de_pago': { num: '10.3', titulo: 'Documentación para el Pago' },
                // Sección 11
                'confidencialidad_11__confidencialidad': { num: '11', titulo: 'Confidencialidad' },
                // Sección 12
                'penalidadMora_12__penalidades': { num: '12', titulo: 'Penalidades por Mora' },
                // Sección 13
                'otrasPenalidadesDescripcion_13__otras_penalidades': { num: '13', titulo: 'Otras Penalidades' },
                // Sección 14
                'content_14__resolucion_del_contrato': { num: '14', titulo: 'Resolución del Contrato' },
                // Sección 15
                'content_15__clausula_garantias': { num: '15', titulo: 'Cláusula Garantías' },
                // Sección 16
                'content_16__clausula_gestion_de_riesgos': { num: '16', titulo: 'Cláusula Gestión de Riesgos' },
                // Sección 17
                'content_17__clausula_anticorrupcion_y_antisoborno': { num: '17', titulo: 'Cláusula Anticorrupción y Antisoborno' },
                // Sección 18
                'content_18__clausula_solucion_de_controversias': { num: '18', titulo: 'Cláusula Solución de Controversias' }
            };

            // Generar secciones dinámicamente
            Object.keys(camposMap).forEach(campo => {
                const info = camposMap[campo];
                const valor = datos[campo];

                if (valor && valor !== '' && valor !== 'No especificado') {
                    html += `<div class="seccion">`;
                    html += `<div class="seccion-titulo">${info.titulo}</div>`;
                    html += `<div class="seccion-contenido">`;
                    html += `<p>${valor}</p>`;
                    html += `</div></div>`;
                }
            });

            // Agregar cláusulas personalizadas (campos que comienzan con "custom_")
            Object.keys(datos).forEach(key => {
                if (key.startsWith('custom_')) {
                    const valor = datos[key];
                    if (valor && valor !== '') {
                        html += `<div class="seccion">`;
                        html += `<div class="seccion-titulo">Cláusula Personalizada</div>`;
                        html += `<div class="seccion-contenido">`;
                        html += `<p>${valor}</p>`;
                        html += `</div></div>`;
                    }
                }
            });

            contenedor.innerHTML = html;

            // Fecha de generacion
            document.getElementById('fecha-generacion').textContent =
                `Documento generado el: ${new Date().toLocaleDateString('es-PE', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`;
        }

        function obtenerNombreMeta(metaId) {
            const metas = {
                '0012': '0012 - Gestion de Abastecimiento y Servicios Generales',
                '0025': '0025 - Gestion de Recursos Humanos',
                '0038': '0038 - Tecnologias de la Informacion',
                '0041': '0041 - Gestion Documentaria y Archivo'
            };
            return metas[metaId] || metaId;
        }

        function obtenerNombresActividades(actividadesArray) {
            if (!actividadesArray || actividadesArray.length === 0) return 'No especificado';
            return actividadesArray.join(', ');
        }

        function volverFormulario() {
            // Los datos ya estan en sessionStorage, solo navegamos de vuelta
            window.location.href = 'index.html';
        }

        function descargarJSON() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const tdrId = `TDR_${timestamp}`;

            const tdrCompleto = {
                id: tdrId,
                fecha_creacion: new Date().toISOString(),
                tipo: 'Servicio',
                meta: datos.metaPresupuestaria || '',
                unidad: datos.unidadOrganizacion || '',
                actividades: datos.actividadPOI || [],
                denominacion: datos.denominacionContratacion || '',
                secciones: datos,
                estado: 'borrador',
                ultima_modificacion: new Date().toISOString()
            };

            const dataStr = JSON.stringify(tdrCompleto, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${tdrId}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`TDR guardado como ${tdrId}.json`);
        }

        // Generar el documento al cargar
        generarDocumento();
    </script>
</body>
</html>
